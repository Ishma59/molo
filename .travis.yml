sudo: false
language: python
services:
  - elasticsearch
  - redis-server
cache: pip

before_install:
  - pip install --upgrade pip
install:
  - pip install -r requirements-dev.txt
  - pip install coveralls
script:
  - flake8 molo
  - molo scaffold testapp
  - flake8 testapp
  - pip install -e testapp
  - py.test --cov
after_success:
  - coveralls
deploy:
  provider: pypi
  distributions: sdist bdist_wheel
  user: Praekelt
  password:
    secure: TrR3EF0bUSLZFjvfp62Jjjc+d0HTjXRR5BGoM7K1ON4buyyq3AGj8Fvc20d8CN/jcpqnibj+L3MNZnFkgEjsCy7GRav42QTVtQPj5Sorodp8qM7e329do6VAtO3iL6uoG258gYD0oqM0PZjlZurGZjksI7P/IsaZXeFh2I4NyS5Dy/m9f1zhzo5fS4H5oOpK8ohTPe3l9yRBXHteaAZYSrC8pc05U82iSaiWY4RbtJfxB2lPsxTJCh7nrjsyOu+jOubxuandve6YrKnCdpb2JQaPOeSBVpxHxhlf47MTTp5Q4DCO0DLA+kDoBZ1aEkM5gULQihjrKRtmbbXr0AmA+KEVdtZ9KySkmZB8W4lJfz+nyhxvKYEujNKoRYsxLBb5Nxxs/wuy/JTSJBQwdxDff8Yqz0o0N4xsMRy389o06QpE1ARqXpNE7+JSODyZT4ojTMVSmuU2CpwxDSR5L6ZA61nhDECoGe39HLgXiB/LTXgLxCt8O41u+gNQwGbE0iL22C1hPrkT5qWgP6YoMIK8PvpJAw2PVlxnaGZISljPQmV5txBSfi8h7u+wPnRJIVqgaWiM9mM27LhjZnMKPUqIspkMEvc0YoAJ6QYRPsATEUMlZIg+U+FCeSlALNd1cCzxiritPPNOYw9JG2PVACLtnmxhe1L9ILVg48t4loeHxUc=
  on:
    tags: true
    all_branches: true

matrix:
  include:
    - python: '2.7'

    # Include a separate job for the node tests
    - language: node_js
      node_js: '6' # LTS version
      cache:
        directories: [client/node_modules]
      before_install:
        - cd client
      install:
        - travis_retry npm install
      script:
        - npm run ci

      # Clear unused build steps
      services: []
      deploy: []
      after_success: []

    # Docker dev image
    - sudo: required
      services: docker
      env:
        - REGISTRY_USER=praekeltorgdeploy
        - secure: "XWu9BQRvElBq0riHKc+R9b9h0cLdHL8V7K1QN1QOst6B0/Ack1lJt2vwn52uze7e+ERPJGjSfAVmaCG8hMJGZrvntAizpPaSDHlJy+jrZM2cQ2E2g0oqifD4/r1kY43LGu5+JTOQIYaQq4l1ixZMAnn5fq336DHP1FXLOhN8clKv6nSzOx8ad8cJlrzHWuHvn6VrMsuFfIybJjobGkzDN4jU+oJzlOq6vkKDDvimpk1+M8t2Td0fR3pRQZp4Nha8qJFc0FyZMjj24gkaWFcotzsxTTM5Qr4tGMkp+NM8tWe6OAMa3p97bfuHlN2pOK6LwhAYV8KJABTHifx/oaOkeSguiYpHpPMA1+/miEa+6b6zK1tVqT1BWxXn0HJDukHY6sa7wmpO4wCnkWqxebeOgGCqxY93VB+plQo5DNEpcZT6yCI8Tb6WQ2X6yxXt4bWE0lSooXS8pYghDh3l9eLOYwQgfbNyBWYclchViwpCLZjYzJ/Qs7qwB6H3yNrzRZtHUb9hs8SK4W2tiniNR52hUMdnxw1od8MhzUipJygLYIXCk9NlXafyUFDH+SZv19yBk5z+bZ5uNuZaUVnr0K67/TxdGgoYhkJCRQc4bkVykMem4W5FLSq3HlgxeLoyBkApERo78hUzldQIB7e67ktyfxNJVIKL1LHqHrIgmdODCGo="
      install:
        - git clone -b dev-image https://github.com/praekeltfoundation/docker-molo-bootstrap.git docker
      before_script:
        - image="$(awk '$1 == "FROM" { print $2; exit }' docker/onbuild/Dockerfile)"
        - cache_from="${image}:develop-onbuild"
        - docker pull "$cache_from" || true
      script:
        - python setup.py bdist_wheel && cp -r dist docker
        - docker build --pull --cache-from "$cache_from" -t "$image" -f docker/dev.dockerfile docker
        - docker build --cache-from "$cache_from" -t "$image:onbuild" docker/onbuild
      before_deploy:
        - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
        - pip install docker-ci-deploy==0.3.0
        - version="$(git rev-parse --short HEAD)"
      deploy:
        provider: script
        script: dcd -t develop -V "$version" -L "$image" && dcd -t develop-onbuild -V "$version" -L "$image:onbuild"
        on:
          branch: develop

      # Clear unused build steps
      cache:
      before_install: []
      after_success: []
